---
name:  geocloud005
title: 地球云计算 005：一切并行计算都是调度问题
date:  2017-4-10
tags: 地球云计算
---
<!-- more -->
![](/cnblog/uploads/geocloud005.jpg)

2004年我进入中科院遥感所，开始使用IDL编程，当时的版本号是7.0，ENVI的版本号是4.6左右。IDL上手快，文档齐全，又集成了ENVI这样的交互界面，在当时是非常实用的选择。我把几个遥感图像模型用IDL接在一起，开始摸索一门姑且称之为“调参”的可疑手艺——这就要求不但跑的数据量大，而且算得快，结果如果看着不对我好来得及把参数再调一遍。关于调参这件事，需要说明的是，如果你对模型足够了解，理解所谓敏感度（sensitivity ），有丰富的经验，手头又有一些验证数据，那还可以叫做调参；如果你知道得不多，又有项目的压力，那就跟猜谜语差不多。为了化解调参的苦闷心情，我突然想到，组里的全部电脑都在一个局域网中，电脑上都有装有IDL，如果能够集中全组的算力来猜谜语，无疑是件好事。我于是写了一个简陋的调度程序，访问放在局域网上的一个任务列单，计算，输出，每台机器的任务都相互不重复，老机器算得慢些，新机器算得快些，但都做了力所能及的贡献。每个任务是否正在执行、是否执行完毕完全由文件名锁来判断，因为当时确实没别的方法可用。

![](/uploads/geocloud005a.jpg)
![](/uploads/geocloud005b.png)
2004年，ENVI4.5，对License的管理极为到位


每天下班之前，我就扫一眼机房，看那些人晚上不用机器，然后打开他们的电脑，把我的调度程序读入，运行起来，看一眼任务管理器，确定CPU和内存都达到了峰值，机器在程序的压榨之下发出沉闷的呻吟，方才兴逞而去。隔壁大组的师兄，数据处理量跟我相去仿佛，他的做法是写了一些类似光荣三国志那种的n多联动菜单的界面，把数据分期分块，让硕士生在上面点来点去，一到月底就好几号人在上面狂点——数据处理不过来。总之，为了处理大量的数据，各显神通。我对计算调度的概念就是这么建立起来的。

2009年，我在意大利的里雅斯特（TRIESTE）的国际理论物理中心（ICTP）学习区域气候模型（RegCM），第一次接触到计算集群（Cluster）。机房里的电脑看上去并没有什么两样，只是网线似乎确实要粗硕些。所有的不同仅在于linux命令行下，交计算任务之前，有一个选择要多少CPU，多少核，你输入了，机器嘀咕一声，再无他话，哪些旁边的机器被启动了，任务如何分配？我统统不知道；第二天早上，所有的结果已经静静地躺在硬盘里，多么简洁！神秘！恰如的里雅斯特的古堡与海湾，让我留连不已。

![](/uploads/geocloud005c.jpg)
2009年，意大利，的里雅斯特

2011年，我来到位于加州硅谷的NASA Ames研究中心，连入了超级计算机昴宿星（Pleiades），这东西跟我在中科院计算所见到的曙光系差不多，在当时的全球综合排名已经掉到了12左右。Pleiades里可以接入NEX（NASA数字地球），里面有下载处理好了的遥感卫星资料和气象数据，是建模者的梦中后宫。我开始学习用Python和C搭pipeline，交任务，到Pleiades那个庞大的CPU池里去要资源。Pleiades的架构是个迷宫，有四套并行的节点系统，有累计25万个CPU核。但是，CPU多就了不起了吗？

![](/uploads/geocloud005d.jpg)
2011年，加州硅谷，NASA Pleiades超算机

人们得通过qsub的脚本去提交任务，申请资源，用一些命令来了解任务等待、运行的情况，有一些文档可看，但通常都只是一些让人困扰的信息，在Pleiades上花了很长时间，除了一些调试的技巧，我始终不知道怎样才能充分地利用它的计算资源。每当有人问我，为什么交完任务两天了都没有被执行？我唯有打入一串不抱希望的命令，然后答道，你还是给系统管理员发个邮件吧。

而实际中，超算机上的工作体验也令人沮丧：各种环境、类库的管理，只是数据处理速度的加快，但还有大量的后处理、可视化脚本需要编写和维护，数据、知识的共享和演进仍十分困难，面对海量数据，科学家们孤独地编织着各自的故事，这些故事的复现、查证和进化要耗费大量的劳动时间，很多情况下几乎不可能。

唯一让人兴奋过一阵的是2013年，超算机奋进号（Endeavour）的接入。没错，NASA的超算机常跟航天飞机（Space Shuttle）取同一个名，比如奋进号、发现号（Discovery）、哥伦比亚号（Columbia）等等，也不嫌乱。奋进号是一台共享内存（shared-memory）的超算机，别的机器IO还要调度，它直接通过一个伞状结构把每个CPU的内存接在了一起，使得你在理论上可以同时访问高达4TB的内存，也就是说，当你拿不准主意如何确定并行粒度的时候可以硬来，根本不用顾虑通常内存的限制，一味蛮干奋进，机如其名。以后我还会说到我在如何在奋进号上奋进的经历。

![](/uploads/geocloud005e.jpg)
2015年，奋进号航天飞机的告别之旅

2013年，Hadoop红遍全球，成为大数据解决方案的主流平台。人们可以在Hadoop上开发的应用层上运行处理海量数据的应用程序，并能充分利用集群的算力实现高速运算和存储。一时间，人们的想象力在喷薄激射，看似所有的资源（内存、存储、处理器）都可以被虚拟化，被动态分配，大家讨论着hadoop能不能干好内核级调度这件事，网络计算，透明计算，什么都来了。

但是，一切都需要一个应用，一个从零到1的应用，它反映出设计者的用心和理解，也能在现实世界获得回应，它封装了已有的大量细节，从而把可能性展现给用户，以实现技术的发展和增长。